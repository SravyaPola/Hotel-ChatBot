<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Home Page of Hotel Chat-Bot</title>

	<!-- External libs (unchanged) -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" />
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<!-- Your custom theme CSS -->
	<link rel="stylesheet" href="home.css" />
</head>

<body>
	<div class="container" style="margin-left: 100px;">
		<h1>Welcome to Booking Hotels Page</h1>
		<h2>Search your desired hotel Below:</h2>
		<button id="btnLogout" title="Logout">
			<i class="fa fa-sign-out"></i>
		</button>

		<!-- === Search Panel === -->
		<div class="search-panel">
			<h5>Narrow your search results</h5>
			<div class="form-row align-items-end">
				<div class="col-3">
					<label for="searchLocation">Hotel/City/State</label>
					<input class="form-control" type="text" id="searchLocation" name="searchLocation" />
				</div>
				<div class="col-2">
					<label for="noRooms">No. Rooms</label>
					<input class="form-control" type="number" id="noRooms" name="noRooms" min="1" value="1" required />
				</div>
				<div class="col-2">
					<label for="noGuests">No. Guests</label>
					<input class="form-control" type="number" id="noGuests" name="noGuests" min="1" value="1"
						required />
				</div>
				<div class="col-2">
					<label for="checkInDate">Check-In Date</label>
					<input class="form-control" type="date" id="checkInDate" name="checkInDate" />
				</div>
				<div class="col-2">
					<label for="checkOutDate">Check-Out Date</label>
					<input class="form-control" type="date" id="checkOutDate" name="checkOutDate" />
				</div>
				<div class="col-auto">
					<button id="searchBtn" class="btn-search">SEARCH</button>
				</div>
			</div>
		</div>

		<!-- === Filters & Results === -->
		<div class="row">
			<aside class="sidebar">
				<h5>Star Rating:</h5>
				<div class="form-check">
					<input type="checkbox" class="star_rating form-check-input" id="1_star_rating" value="1" />
					<label class="form-check-label" for="1_star_rating">1</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="star_rating form-check-input" id="2_star_rating" value="2" />
					<label class="form-check-label" for="2_star_rating">2</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="star_rating form-check-input" id="3_star_rating" value="3" />
					<label class="form-check-label" for="3_star_rating">3</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="star_rating form-check-input" id="4_star_rating" value="4" />
					<label class="form-check-label" for="4_star_rating">4</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="star_rating form-check-input" id="5_star_rating" value="5" />
					<label class="form-check-label" for="5_star_rating">5</label>
				</div>

				<div class="slider-container">
					<label for="priceRange">Range:</label>
					<input type="range" min="1" max="500" value="500" class="slider" id="priceRange" />
					<p>Price: $<span id="priceValue">500</span></p>
				</div>

				<h5>Filters:</h5>
				<div class="form-check">
					<input type="checkbox" class="hotel_amenity form-check-input" id="amenity_parking"
						value="PARKING" />
					<label class="form-check-label" for="amenity_parking">Parking</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="hotel_amenity form-check-input" id="amenity_breakfast"
						value="BREAKFAST" />
					<label class="form-check-label" for="amenity_breakfast">Breakfast</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="hotel_amenity form-check-input" id="amenity_wifi" value="WIFI" />
					<label class="form-check-label" for="amenity_wifi">WiFi</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="hotel_amenity form-check-input" id="amenity_fitness_center"
						value="FITNESS CENTER" />
					<label class="form-check-label" for="amenity_fitness_center">Fitness Center</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="hotel_amenity form-check-input" id="amenity_bar_lounge"
						value="BAR OR LOUNGE" />
					<label class="form-check-label" for="amenity_bar_lounge">Bar / Lounge</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="hotel_amenity form-check-input" id="amenity_spa_services"
						value="SPA SERVICES" />
					<label class="form-check-label" for="amenity_spa_services">Spa Services</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="hotel_amenity form-check-input" id="amenity_swimming_pool"
						value="SWIMMING POOL" />
					<label class="form-check-label" for="amenity_swimming_pool">Swimming Pool</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="hotel_amenity form-check-input" id="amenity_pet_friendly"
						value="PET-FRIENDLY" />
					<label class="form-check-label" for="amenity_pet_friendly">Pet-Friendly</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="hotel_amenity form-check-input" id="amenity_airport_shuttle"
						value="AIRPORT SHUTTLE" />
					<label class="form-check-label" for="amenity_airport_shuttle">Airport Shuttle</label>
				</div>
				<div class="form-check">
					<input type="checkbox" class="hotel_amenity form-check-input" id="amenity_business_center"
						value="BUSINESS CENTER" />
					<label class="form-check-label" for="amenity_business_center">Business Center</label>
				</div>

				<button id="filterBtn" class="btn-search">FILTER</button>
			</aside>

			<section class="results">
				<h5>List of Hotels:</h5>
				<div id="listHotel"><!-- Dynamically populated by AJAX --></div>
			</section>
		</div>
	</div>

	<div id="chatOverlay"></div>
	<div id="chatWidget" class="chat-closed">
		<!-- Chat Icon (always visible when closed) -->
		<div id="chatHeader" class="chat-icon">
			<i class="fa fa-comments"></i>
		</div>
		<!-- Chat Panel (visible only when open) -->
		<div class="chat-panel">
			<button id="chatClose" class="chat-close"><i class="fa fa-times"></i></button>
			<div id="chatBody" class="chat-body"></div>
			<div id="chatInput" class="chat-input">
				<select id="language-select">
					<option value="en" selected>English</option>
					<option value="es">Español</option>
					<option value="fr">Français</option>
					<option value="de">Deutsch</option>
				</select>
				<input id="chatMsg" placeholder="Type a message…" />
				<button id="sendChat"><i class="fa fa-paper-plane"></i></button>
			</div>
		</div>
	</div>




	<!-- === Modal: Search Hotel Rooms === -->
	<div class="modal" id="myModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Search Hotel Rooms</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>

				<!-- Modal body -->
				<div class="modal-body">
					<form id="searchRoomsForm" novalidate>
						<input type="hidden" id="modal_hotelId" />

						<div class="form-group">
							<label for="modal_hotelName">Hotel Name:</label>
							<input readonly class="form-control" type="text" id="modal_hotelName" required />
						</div>

						<div class="form-group">
							<label for="modal_noGuests">No. Guests:</label>
							<input class="form-control" type="number" id="modal_noGuests" min="1" value="1" required />
						</div>

						<div class="form-group">
							<label for="modal_checkInDate">Check-In Date:</label>
							<input class="form-control" type="date" id="modal_checkInDate" required />
						</div>

						<div class="form-group">
							<label for="modal_checkOutDate">Check-Out Date:</label>
							<input class="form-control" type="date" id="modal_checkOutDate" required />
						</div>

						<div class="form-group">
							<label for="select_roomTypes">Room Type:</label>
							<select class="form-control" id="select_roomTypes" required>
								<!-- options populated by AJAX -->
							</select>
						</div>

						<div class="form-group">
							<label for="modal_noRooms">No. Rooms:</label>
							<input class="form-control" type="number" id="modal_noRooms" min="1" value="1" required />
						</div>

						<button type="button" style="margin-top: 25px;" class="btn btn-primary btn-block"
							id="modalSearchBtn">
							SEARCH
						</button>
					</form>
				</div>

				<!-- Modal footer -->
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- === Modal: Confirm Hotel Room Details === -->
	<div class="modal" id="hotelRoomsModal">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Are these details correct?</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>

				<!-- Modal body -->
				<div class="modal-body" id="hotelRooms_modalBody">
					<!-- Dynamically populated by AJAX -->
				</div>

				<!-- Modal footer -->
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<!-- === Modal: Hotel Details === -->
	<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Hotel Details</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>

				<div class="modal-body" id="detailsModalBody">
					<!-- will be populated dynamically -->
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">
						Close
					</button>
				</div>
			</div>
		</div>
	</div>







	<!-- === Modal: Booking Confirmation === -->
	<div class="modal fade" id="bookingHotelRoomModal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
			<div class="modal-content">
				<!-- 1) Header -->
				<div class="modal-header">
					<h4 class="modal-title">Confirm Your Booking</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>

				<!-- 2) Body (scrollable) -->
				<div class="modal-body">
					<form id="bookingForm" novalidate>
						<!-- placeholder for server response -->
						<div id="booking_response" class="alert mt-3" style="display: none;"></div>
						<input type="hidden" id="booking_hotelId" required />
						<input type="hidden" id="booking_hotelRoomId" required />

						<div class="form-group">
							<label>Hotel Name</label>
							<input readonly class="form-control" id="booking_hotelName" required />
						</div>
						<div class="form-group">
							<label>Customer Name</label>
							<input class="form-control" id="booking_customerName" required />
						</div>
						<div class="form-group">
							<label>No. Guests</label>
							<input readonly class="form-control" id="booking_noGuests" required />
						</div>
						<div class="form-group">
							<label>No. Rooms</label>
							<input readonly class="form-control" id="booking_noRooms" required />
						</div>
						<div class="form-group">
							<label>Check-In Date</label>
							<input readonly class="form-control" id="booking_checkInDate" required />
						</div>
						<div class="form-group">
							<label>Check-Out Date</label>
							<input readonly class="form-control" id="booking_checkOutDate" required />
						</div>
						<div class="form-group">
							<label>Room Type</label>
							<input readonly class="form-control" id="booking_roomType" required />
						</div>
						<div class="form-group">
							<label>Price per Night</label>
							<div>$<span id="booking_price"></span></div>
						</div>
					</form>
				</div>

				<!-- 3) Footer (always visible) -->
				<div class="modal-footer">
					<button type="button" class="btn btn-primary btn-confirm-booking">
						Confirm Booking
					</button>
					<button type="button" class="btn btn-secondary btn-edit-booking">
						Edit
					</button>
					<button type="button" class="btn btn-danger" data-dismiss="modal">
						Close
					</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		// === Slider for price range (left filter) ===
		var slider = document.getElementById("priceRange");
		var output = document.getElementById("priceValue");
		output.innerHTML = slider.value;
		slider.oninput = function () {
			output.innerHTML = this.value;
		};

		// === AJAX & Event Listeners ===
		$(document).ready(function () {
			$("#filterBtn").click(function () {
				const selectedStars = $(".star_rating:checked")
					.map((_, e) => +e.value)
					.get();
				const maxPrice = +$("#priceRange").val();
				const selectedAms = $(".hotel_amenity:checked")
					.map((_, el) => el.value.toLowerCase().trim())
					.get();
				const skipAmenityFilter = selectedAms.length === 0;
				$(".hotel-card").each(function () {
					const $card = $(this);
					const stars = +$card.data("stars");
					const price = +$card.data("price");
					const ams = ($card.data("amenities") || "")
						.split("|")
						.map((a) => a.toLowerCase().trim())
						.filter((a) => a);

					let visible = true;

					// 1. Star filter
					if (selectedStars.length && !selectedStars.includes(stars)) {
						visible = false;
					}

					// 2. Price filter
					if (visible && price > maxPrice) {
						visible = false;
					}

					// 3. Amenities filter
					if (visible && !skipAmenityFilter) {
						// require _all_ selectedAms be in the card's ams array
						if (!selectedAms.every((a) => ams.includes(a))) {
							visible = false;
						}
					}

					$card.toggle(visible);
				});
			});

			// keep check-out >= check-in
			$("#checkInDate").on("change", function () {
				const inDate = this.value;
				// set the earliest check-out
				$("#checkOutDate")
					.attr("min", inDate)
					// if the current check-out is before, clear it
					.val((old) => (old < inDate ? "" : old));
			});

			// 1. Search Hotels (when clicking SEARCH button)
			$("#searchBtn").click(function () {
				let searchLocation = $("#searchLocation").val();
				let checkIn = $("#checkInDate").val();
				let checkOut = $("#checkOutDate").val();
				let noRooms = parseInt($("#noRooms").val(), 10);
				let noGuests = parseInt($("#noGuests").val(), 10);
				if (noRooms < 1 || noGuests < 1) {
					alert("Please enter at least 1 room and 1 guest.");
					return;
				}
				if (checkOut < checkIn) {
					alert("Check-Out date must be on or after Check-In date.");
					return;
				}
				$.ajax({
					url: "/api/search-hotels",
					method: "GET",
					data: {
						searchHotel: searchLocation,
						checkIn: checkIn,
						checkOut: checkOut,
						noOfRooms: noRooms,
						noOfGuests: noGuests,
					},
					success: function (hotels) {
						$("#listHotel").empty();
						if (hotels.length === 0) {
							$("#listHotel").append("<p>No hotels found.</p>");
						} else {
							hotels.forEach(function (hotel) {
								const amList = hotel.amenities.join("|");
								const html = `
				    <div class="card hotel-card"
				         data-stars="${hotel.starRating}"
				         data-price="${hotel.averagePrice}"
				         data-amenities="${amList}"
				         style="margin-bottom:20px">
				      <div class="card-body">
				        <h5 class="card-title">
				          ${hotel.hotelName} (${hotel.starRating})
				        </h5>
				        <p class="card-text">
				          ${hotel.city}, ${hotel.state}
				        </p>

				        <!-- button row: flex container, right aligned -->
				        <div class="d-flex justify-content-end">
				          <button class="btn btn-secondary mr-2 viewDetailsBtn"
				                  data-hotelid="${hotel.hotelId}"
				                  data-hotelname="${hotel.hotelName}">
				            View Details
				          </button>
				          <button class="btn btn-primary openRoomsModal"
				                  data-hotelid="${hotel.hotelId}"
				                  data-hotelname="${hotel.hotelName}"
				                  data-noGuests="${noGuests}"
				                  data-checkin="${checkIn}"
				                  data-checkout="${checkOut}">
				            Search Rooms
				          </button>
				        </div>
				      </div>
				    </div>`;

								$("#listHotel").append(html);
							});
						}
					},
					error: function (err) {
						alert("Error fetching hotels.");
						console.error(err);
					},
				});
			});

			// 2. When user clicks “Search Rooms” on a particular hotel card, open the first modal
			$(document).on("click", ".openRoomsModal", function () {
				let hotelId = $(this).data("hotelid");
				let hotelName = $(this).data("hotelname");
				let noGuests = $(this).data("noguests");
				let checkIn = $(this).data("checkin");
				let checkOut = $(this).data("checkout");

				$("#modal_hotelId").val(hotelId);
				$("#modal_hotelName").val(hotelName);
				$("#modal_noGuests").val(noGuests);
				$("#modal_checkInDate").val(checkIn);
				$("#modal_checkOutDate").val(checkOut);

				// a) Populate room types dropdown
				$.ajax({
					url: "/api/room-types",
					method: "GET",
					success: function (roomTypes) {
						$("#select_roomTypes").empty();
						roomTypes.forEach(function (rt) {
							$("#select_roomTypes").append(`<option value="${rt.typeId}">${rt.name}</option>`);
						});
					},
				});

				$("#myModal").modal("show");
			});

			$("#modal_checkInDate").on("change", function () {
				const inDate = this.value;
				$("#modal_checkOutDate")
					.attr("min", inDate)
					.val((old) => (old < inDate ? "" : old));
			});
			// 3. When user clicks “SEARCH” inside the first modal (Search Hotel Rooms):
			$("#modalSearchBtn").click(function () {
				// 1) run browser’s built-in validation
				const form = document.getElementById("searchRoomsForm");
				if (!form.checkValidity()) {
					form.reportValidity();
					return; // stop here if any required field is empty/invalid
				}

				// 2) now gather all the values
				let hotelId = $("#modal_hotelId").val();
				let hotelName = $("#modal_hotelName").val();
				let noGuests = parseInt($("#modal_noGuests").val(), 10);
				let checkIn = $("#modal_checkInDate").val();
				let checkOut = $("#modal_checkOutDate").val();
				let roomTypeId = $("#select_roomTypes").val();
				let noRooms = parseInt($("#modal_noRooms").val(), 10);
				if (noRooms < 1 || noGuests < 1) {
					alert("Please select at least 1 room and 1 guest.");
					return;
				}
				if (checkOut < checkIn) {
					alert("Check-Out date must be on or after Check-In date.");
					return;
				}
				// 3) build your payload
				let payload = {
					hotelId: parseInt(hotelId, 10),
					checkInDate: checkIn,
					checkOutDate: checkOut,
					noRooms: parseInt(noRooms, 10),
					noGuests: parseInt(noGuests, 10),
				};

				// 4) fire the AJAX
				$.ajax({
					url: "/api/search-hotel-rooms",
					method: "POST",
					contentType: "application/json",
					data: JSON.stringify(payload),

					success: function (rooms) {
						const $modal = $("#hotelRoomsModal");
						const $title = $modal.find(".modal-title");
						const $body = $("#hotelRooms_modalBody");
						const $footer = $modal.find(".modal-footer");

						$body.empty();

						if (!rooms.length) {
							$title.text("No rooms available");
							$body.append("<p>Sorry, we couldn’t find any rooms for those dates.</p>");
							// hide the Confirm/Edit buttons
							$footer.find(".btn-confirm-room, .btn-edit-booking").hide();
						} else {
							// find the room matching the selected type
							let room = rooms.find((r) => r.type.typeId == roomTypeId);
							if (!room) {
								$title.text("No matching room type");
								$body.append("<p>Sorry, that room type isn't available.</p>");
								$footer.find(".btn-confirm-room, .btn-edit-booking").hide();
							} else {
								// we have a valid room → show the normal confirmation UI
								$title.text("Are these details correct?");

								// here’s your “existing template for showing the room details”
								const html = `
		          <p><strong>Hotel:</strong> ${hotelName}</p>
		          <p><strong>Room Type:</strong> ${room.type.name}</p>
		          <p><strong>Description:</strong> ${room.description}</p>
		          <p><strong>Policies:</strong> ${room.policies}</p>
		          <p><strong>Price/Night:</strong> $${room.price}</p>
		          <p><strong>Check-In:</strong> ${checkIn}</p>
		          <p><strong>Check-Out:</strong> ${checkOut}</p>
		          <p><strong>No. Guests:</strong> ${noGuests}</p>
		          <button class="btn btn-primary btn-confirm-room" 
		                  data-hotelid="${hotelId}"
		                  data-hotelroomid="${room.hotelRoomId}"
		                  data-hotelname="${hotelName}"
		                  data-roomtypeid="${room.type.typeId}"
		                  data-roomtypename="${room.type.name}"
		                  data-price="${room.price}"
		                  data-checkin="${checkIn}"
		                  data-checkout="${checkOut}"
		                  data-noguests="${noGuests}"
						  data-norooms="${noRooms}">
		            Proceed to Book
		          </button>
		        `;

								$body.html(html);
								// make sure Confirm/Edit are visible
								$footer.find(".btn-confirm-room, .btn-edit-booking").show();
							}
						}

						// swap modals
						$modal.modal("show");
						$("#myModal").modal("hide");
					},

					error: function (err) {
						alert("Error fetching rooms.");
						console.error(err);
					},
				});
			});

			// 4. When user clicks “Proceed to Book” in the second modal:
			$(document).on("click", ".btn-confirm-room", function () {
				let hotelId = $(this).data("hotelid");
				let hotelRoomId = $(this).data("hotelroomid");
				let hotelName = $(this).data("hotelname");
				let roomTypeId = $(this).data("roomtypeid");
				let roomTypeName = $(this).data("roomtypename");
				let price = $(this).data("price");
				let checkIn = $(this).data("checkin");
				let checkOut = $(this).data("checkout");
				let noGuests = $(this).data("noguests");
				let noRooms = $(this).data("norooms");
				// Populate the final booking modal:
				$("#booking_hotelId").val(hotelId);
				$("#booking_hotelRoomId").val(hotelRoomId);
				$("#booking_hotelName").val(hotelName);
				$("#booking_noGuests").val(noGuests);
				$("#booking_noRooms").val(noRooms);
				$("#booking_checkInDate").val(checkIn);
				$("#booking_checkOutDate").val(checkOut);
				$("#booking_roomType").val(roomTypeName);
				$("#booking_price").text(price);
				$("#bookingHotelRoomModal").modal("show");
				$("#hotelRoomsModal").modal("hide");
			});

			$('#btnLogout').on('click', () => {
				$.ajax({
					url: '/api/auth/logout',
					method: 'POST',
					xhrFields: {withCredentials: true},
					complete: () => {
						window.location = '/login.html';
					}
				});
			});


			// 5. When user clicks “Confirm Booking” in the final modal:
			$(document).on("click", ".btn-confirm-booking", function () {
				// 1) HTML5 form validation
				const form = document.getElementById("bookingForm");
				if (!form.checkValidity()) {
					form.reportValidity();
					return;
				}

				// 2) gather payload
				const payload = {
					hotelId: parseInt($("#booking_hotelId").val(), 10),
					hotelRoomId: parseInt($("#booking_hotelRoomId").val(), 10),
					noRooms: parseInt($("#booking_noRooms").val(), 10),
					noGuests: parseInt($("#booking_noGuests").val(), 10),
					checkInDate: $("#booking_checkInDate").val(),
					checkOutDate: $("#booking_checkOutDate").val(),
					customerName: $("#booking_customerName").val(),
				};
				if (checkOutDate < checkInDate) {
					alert("Check-Out date must be on or after Check-In date.");
					return;
				}
				// 3) AJAX POST to your controller
				$.ajax({
					url: "/api/booking",
					method: "POST",
					contentType: "application/json",
					data: JSON.stringify(payload),

					success: function (res) {
						// display success inside the modal
						$("#booking_response")
							.removeClass("alert-danger")
							.addClass("alert-success")
							.text("Booking confirmed! Your confirmation ID is " + res.confirmationId)
							.show();
						// disable buttons to prevent re-submit
						$(".btn-confirm-booking, .btn-edit-booking").prop("disabled", true);
					},

					error: function (xhr) {
						let msg = "Error booking room.";

						// try JSON payload first
						if (xhr.responseJSON) {
							// your controller returns { error: "…" }
							if (xhr.responseJSON.error) {
								msg += " " + xhr.responseJSON.error;
							} else if (xhr.responseJSON.message) {
								msg += " " + xhr.responseJSON.message;
							}
						}
						// if it's not valid JSON or no fields, fall back to plain text
						else if (xhr.responseText) {
							msg += " " + xhr.responseText;
						}
						$("#booking_response").removeClass("alert-success").addClass("alert-danger").text(msg).show();
					},
				});
			});
			//view-hotel-details
			$(document).on("click", ".viewDetailsBtn", function () {
				const hotelId = $(this).data("hotelid");
				const hotelName = $(this).data("hotelname");

				const $modal = $("#detailsModal");
				const $title = $modal.find(".modal-title");
				const $body = $("#detailsModalBody");

				// Set the header and show a loading message
				$title.text(hotelName);
				$body.html("<p>Loading details…</p>");
				$modal.modal("show");

				// Fetch the hotel by ID
				$.ajax({
					url: `/api/hotels/${hotelId}`,
					method: "GET",
					success: function (hotel) {
						// Build a simple details layout
						let html = `
        <h4>${hotel.hotelName} (${hotel.starRating})</h4>
        <p><strong>Address:</strong> ${hotel.address}, ${hotel.city}, ${hotel.state}</p>
        <p><strong>Average Price:</strong> $${hotel.averagePrice.toFixed(2)}</p>
        <p><strong>Description:</strong> ${hotel.description || "N/A"}</p>
        <p><strong>Email:</strong> ${hotel.email}</p>
        <p><strong>Phone:</strong> ${hotel.mobile}</p>
        <p><strong>Times Booked:</strong> ${hotel.timesBooked}</p>
        <p><strong>Amenities:</strong> 
          ${hotel.amenities && hotel.amenities.length ? hotel.amenities.join(", ") : "None"}
        </p>
      `;
						$body.html(html);
					},
					error: function () {
						$body.html("<p class='text-danger'>Error loading hotel details.</p>");
					},
				});
			});
		});

		$(document).ready(function () {
			// Open chat: click the chat icon
			$("#chatHeader").on("click", function () {
				$("#chatWidget").removeClass("chat-closed").addClass("chat-open");
			});
			// Close chat: click the close (X) button
			$("#chatClose").on("click", function () {
				$("#chatWidget").removeClass("chat-open").addClass("chat-closed");
			});

			// Your chat message sending logic
			let convState = null;

			$("#sendChat").on("click", function () {
				const msg = $("#chatMsg").val().trim();
				if (!msg) return;
				$("#chatBody").append(`<div class="you-msg"><strong>You:</strong> ${msg}</div>`);
				$("#chatMsg").val("");
				$.ajax({
					url: "/api/chat",
					type: "POST",
					contentType: "application/json",
					dataType: "json",
					data: JSON.stringify({
						message: msg,
						state: convState,
						language: $("#language-select").val()
					}),
					success: data => {
						convState = data.state;
						const $chat = $("#chatBody");

						// Parse markdown message into HTML
						const htmlContent = marked.parse(data.message);

						// Insert bot message with rendered HTML, keep label and styling
						const $bot = $(`
					        <div class="bot-msg">
					            <strong>Bot:</strong><br/>${htmlContent}
					        </div>
					    `);
						$chat.append($bot);

						// --- Disable ALL previous suggestions, always ---
						$('.suggestions-wrap .suggestion-item').addClass('disabled').attr('disabled', true);

						// --- Add new suggestions (if any), with a unique group id (optional but helps future-proofing) ---
						if (data.suggestions && data.suggestions.length) {
							const suggId = `sugg-${Date.now()}`;
							const $suggWrap = $(`<div class="suggestions-wrap" id="${suggId}"></div>`);
							data.suggestions.forEach(text => {
								$suggWrap.append(`<span class="suggestion-item">${text}</span>`);
							});
							$bot.append($suggWrap);
						}

						$chat.scrollTop($chat.prop("scrollHeight"));
					},
					error: () => {
						$("#chatBody").append("<div><em>Sorry, something went wrong.</em></div>");
					}
				});
			});

			$("#chatMsg").on("keypress", function (e) {
				if (e.which === 13) {
					$("#sendChat").click();
					return false;
				}
			});

			$(document).on('click', '.suggestion-item', function () {
				// Only allow clicking if not already disabled
				if ($(this).hasClass('disabled')) return;
				// Disable all suggestions in the current group
				const $wrap = $(this).closest('.suggestions-wrap');
				$wrap.find('.suggestion-item').addClass('disabled').attr('disabled', true);
				// Send as message
				$("#chatMsg").val($(this).text());
				$("#sendChat").click();
			});

			function renderHotels(hotels) {
				const $list = $("#listHotel").empty();
				if (!hotels.length) {
					return $list.append("<p>No hotels found.</p>");
				}
				hotels.forEach(function (hotel) {
					const amList = hotel.amenities.join("|");
					const card = `
			          <div class="card hotel-card"
			               data-stars="${hotel.starRating}"
			               data-price="${hotel.averagePrice}"
			               data-amenities="${amList}"
			               style="margin-bottom:20px">
			            <div class="card-body">
			              <h5 class="card-title">${hotel.hotelName} (${hotel.starRating})</h5>
			              <p class="card-text">${hotel.city}, ${hotel.state}</p>
			              <div class="d-flex justify-content-end">
			                <button class="btn btn-secondary mr-2 viewDetailsBtn"
			                        data-hotelid="${hotel.hotelId}"
			                        data-hotelname="${hotel.hotelName}">
			                  View Details
			                </button>
			                <button class="btn btn-primary openRoomsModal"
			                        data-hotelid="${hotel.hotelId}"
			                        data-hotelname="${hotel.hotelName}"
			                        data-noGuests="${$("#noGuests").val()}"
			                        data-checkin="${$("#checkInDate").val()}"
			                        data-checkout="${$("#checkOutDate").val()}">
			                  Search Rooms
			                </button>
			              </div>
			            </div>
			          </div>`;
					$list.append(card);
				});
			}

			// --- 2) Load all hotels on page load ---
			$.ajax({
				url: "/api/hotels",
				method: "GET",
				success: function (hotels) {
					renderHotels(hotels);
				},
				error: function () {
					$("#listHotel").html("<p class='text-danger'>Failed to load hotels.</p>");
				}
			});

			// --- 3) Wire up SEARCH button to re-use that same renderer ---
			$("#searchBtn").click(function () {
				const params = {
					searchHotel: $("#searchLocation").val(),
					checkIn: $("#checkInDate").val(),
					checkOut: $("#checkOutDate").val(),
					noOfRooms: $("#noRooms").val(),
					noOfGuests: $("#noGuests").val()
				};
				$.ajax({
					url: "/api/search-hotels",
					method: "GET",
					data: params,
					success: renderHotels,
					error: () => alert("Error fetching hotels.")
				});
			});

		});

	</script>

</body>

</html>